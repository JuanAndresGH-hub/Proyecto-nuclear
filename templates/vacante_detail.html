{% extends 'base.html' %}
{% load static %}

{% block title %}{{ vacante.titulo }} - Sistema de Gestión de Prácticas{% endblock %}

{% block topbar_title %}Detalle de Vacante{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-briefcase"></i> {{ vacante.titulo }}</h1>
    <p>{{ vacante.empresa.nombre }}</p>
</div>

<div class="row">
    <!-- Columna principal -->
    <div class="col-lg-8">
        <!-- Información de la Vacante -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Información de la Vacante</h5>
                {% if vacante.estado == 'ACTIVA' %}
                    <span class="badge" style="background-color: #d1f0e3; color: #0f5130; font-size: 1rem;">
                        <i class="fas fa-check-circle"></i> Activa
                    </span>
                {% else %}
                    <span class="badge" style="background-color: #f8d7da; color: #842029; font-size: 1rem;">
                        <i class="fas fa-times-circle"></i> Cerrada
                    </span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h5 style="margin-bottom: 15px; color: #212529;">Descripción del Puesto</h5>
                    <p style="margin: 0; color: #495057; line-height: 1.8; white-space: pre-wrap;">{{ vacante.descripcion }}</p>
                </div>

                <hr>

                <div class="mb-4">
                    <h5 style="margin-bottom: 15px; color: #212529;">
                        <i class="fas fa-user-graduate"></i> Perfil Requerido
                    </h5>
                    <div style="background: #f8f9fa; padding: 20px; border-left: 4px solid #0dcaf0; border-radius: 4px;">
                        <p style="margin: 0; color: #495057; line-height: 1.8; white-space: pre-wrap;">{{ vacante.perfil_requerido }}</p>
                    </div>
                </div>

                <hr>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <small style="color: #6c757d; display: block; margin-bottom: 5px;">
                            <i class="fas fa-map-marker-alt"></i> Modalidad
                        </small>
                        <p style="margin: 0; font-weight: 500; font-size: 1.1rem;">
                            {% if vacante.modalidad == 'PRESENCIAL' %}
                                <span class="badge" style="background-color: #0dcaf0; color: white;">
                                    <i class="fas fa-building"></i> Presencial
                                </span>
                            {% elif vacante.modalidad == 'REMOTO' %}
                                <span class="badge" style="background-color: #198754; color: white;">
                                    <i class="fas fa-laptop-house"></i> Remoto
                                </span>
                            {% elif vacante.modalidad == 'HIBRIDO' %}
                                <span class="badge" style="background-color: #ffc107; color: #000;">
                                    <i class="fas fa-random"></i> Híbrido
                                </span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <small style="color: #6c757d; display: block; margin-bottom: 5px;">
                            <i class="fas fa-calendar-alt"></i> Duración
                        </small>
                        <p style="margin: 0; font-weight: 500; font-size: 1.1rem;">{{ vacante.duracion_meses }} meses</p>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <small style="color: #6c757d; display: block; margin-bottom: 5px;">
                            <i class="fas fa-calendar-check"></i> Fecha Inicio Estimada
                        </small>
                        <p style="margin: 0; font-weight: 500;">{{ vacante.fecha_inicio_estimada|date:"d/m/Y" }}</p>
                    </div>
                    <div class="col-md-6">
                        <small style="color: #6c757d; display: block; margin-bottom: 5px;">
                            <i class="fas fa-calendar-times"></i> Fecha Fin Estimada
                        </small>
                        <p style="margin: 0; font-weight: 500;">{{ vacante.fecha_fin_estimada|date:"d/m/Y" }}</p>
                    </div>
                </div>

                {% if vacante.salario_rango %}
                <div class="mb-3">
                    <small style="color: #6c757d; display: block; margin-bottom: 5px;">
                        <i class="fas fa-dollar-sign"></i> Rango Salarial
                    </small>
                    <p style="margin: 0; font-weight: 500; font-size: 1.1rem; color: #198754;">{{ vacante.salario_rango }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Postulaciones (si el usuario es coordinador) -->
        {% if user.es_coordinador %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-users"></i> Postulaciones Recibidas</h5>
            </div>
            <div class="card-body">
                {% if vacante.postulaciones.all %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Origen</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for postulacion in vacante.postulaciones.all %}
                                <tr>
                                    <td>
                                        <strong>{{ postulacion.estudiante.usuario.get_full_name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ postulacion.estudiante.programa_academico }}</small>
                                    </td>
                                    <td>{{ postulacion.fecha_postulacion|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        {% if postulacion.estado == 'EN_REVISION' %}
                                            <span class="badge" style="background-color: #fff3cd; color: #664d03;">En Revisión</span>
                                        {% elif postulacion.estado == 'ACEPTADA' %}
                                            <span class="badge" style="background-color: #d1f0e3; color: #0f5130;">Aceptada</span>
                                        {% elif postulacion.estado == 'RECHAZADA' %}
                                            <span class="badge" style="background-color: #f8d7da; color: #842029;">Rechazada</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if postulacion.origen == 'ESTUDIANTE' %}
                                            <i class="fas fa-user"></i> Estudiante
                                        {% else %}
                                            <i class="fas fa-user-tie"></i> Coordinador
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p style="color: #6c757d; text-align: center; padding: 20px;">
                        <i class="fas fa-info-circle"></i> No hay postulaciones aún para esta vacante.
                    </p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Columna lateral -->
    <div class="col-lg-4">
        <!-- Información de la Empresa -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-building"></i> Empresa</h5>
            </div>
            <div class="card-body">
                <h6 style="margin-bottom: 15px;">{{ vacante.empresa.nombre }}</h6>

                {% if vacante.empresa.ciudad %}
                <p style="margin: 5px 0; color: #6c757d; font-size: 0.9rem;">
                    <i class="fas fa-map-marker-alt"></i> {{ vacante.empresa.ciudad }}
                </p>
                {% endif %}

                {% if vacante.empresa.telefono %}
                <p style="margin: 5px 0; color: #6c757d; font-size: 0.9rem;">
                    <i class="fas fa-phone"></i> {{ vacante.empresa.telefono }}
                </p>
                {% endif %}

                {% if vacante.empresa.correo %}
                <p style="margin: 5px 0; color: #6c757d; font-size: 0.9rem;">
                    <i class="fas fa-envelope"></i> {{ vacante.empresa.correo }}
                </p>
                {% endif %}

                {% if vacante.empresa.direccion %}
                <hr>
                <p style="margin: 5px 0; color: #6c757d; font-size: 0.9rem;">
                    <i class="fas fa-map"></i> {{ vacante.empresa.direccion }}
                </p>
                {% endif %}

                {% if vacante.empresa.descripcion %}
                <hr>
                <small style="color: #6c757d; display: block; margin-bottom: 5px;">Sobre la empresa</small>
                <p style="margin: 0; color: #495057; font-size: 0.85rem; line-height: 1.6;">
                    {{ vacante.empresa.descripcion|truncatewords:30 }}
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Estadísticas</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small style="color: #6c757d; display: block;">Plazas Disponibles</small>
                    <h4 style="margin: 0; color: #212529;">{{ vacante.cantidad_plazas }}</h4>
                </div>
                <div class="mb-3">
                    <small style="color: #6c757d; display: block;">Postulaciones</small>
                    <h4 style="margin: 0; color: #212529;">{{ vacante.postulaciones.count }}</h4>
                </div>
                <div>
                    <small style="color: #6c757d; display: block;">Publicada el</small>
                    <p style="margin: 0; color: #495057;">{{ vacante.fecha_creacion|date:"d/m/Y" }}</p>
                </div>
            </div>
        </div>

        <!-- Botón de Postulación (solo para estudiantes) -->
        {% if user.es_estudiante and vacante.estado == 'ACTIVA' %}
        <div class="card">
            <div class="card-body text-center">
                {% if user.perfil_estudiante.estado_hv == 'APROBADA' %}
                    <!-- Verificar si ya está postulado -->
                    {% with postulacion=vacante.postulaciones.all|first %}
                        {% if postulacion and postulacion.estudiante.id == user.perfil_estudiante.id %}
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle"></i> Ya te has postulado a esta vacante
                            </div>
                            <p style="color: #6c757d; font-size: 0.9rem;">
                                Estado:
                                {% if postulacion.estado == 'EN_REVISION' %}
                                    <span class="badge" style="background-color: #fff3cd; color: #664d03;">En Revisión</span>
                                {% elif postulacion.estado == 'ACEPTADA' %}
                                    <span class="badge" style="background-color: #d1f0e3; color: #0f5130;">Aceptada</span>
                                {% elif postulacion.estado == 'RECHAZADA' %}
                                    <span class="badge" style="background-color: #f8d7da; color: #842029;">Rechazada</span>
                                {% endif %}
                            </p>
                        {% else %}
                            <form method="POST" action="#">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-paper-plane"></i> Postularme
                                </button>
                            </form>
                            <p style="color: #6c757d; font-size: 0.85rem; margin-top: 10px;">
                                Tu hoja de vida será enviada automáticamente
                            </p>
                        {% endif %}
                    {% endwith %}
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Hoja de vida requerida</strong>
                        <p style="margin: 10px 0 0 0; font-size: 0.9rem;">
                            Debes tener tu hoja de vida aprobada para postularte.
                        </p>
                    </div>
                    <a href="{% url 'dashboard_estudiante' %}" class="btn btn-dark w-100">
                        <i class="fas fa-upload"></i> Subir Hoja de Vida
                    </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="d-flex gap-3 mt-4">
    <a href="{% url 'empresas:vacantes_list' %}" class="btn btn-dark">
        <i class="fas fa-arrow-left"></i> Volver a Vacantes
    </a>
    {% if user.es_coordinador %}
        <a href="#" class="btn btn-dark">
            <i class="fas fa-edit"></i> Editar Vacante
        </a>
        <button class="btn btn-danger" onclick="cerrarVacante()">
            <i class="fas fa-times-circle"></i> Cerrar Vacante
        </button>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
{% if user.es_coordinador %}
<script>
function cerrarVacante() {
    if (confirm('¿Estás seguro de que deseas cerrar esta vacante? Los estudiantes no podrán postularse más.')) {
        // Implementar lógica de cierre
        alert('Funcionalidad de cierre en desarrollo');
    }
}
</script>
{% endif %}
{% endblock %}

