{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Postulaciones - Sistema de Gestión de Prácticas{% endblock %}

{% block topbar_title %}Gestión de Postulaciones{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-handshake"></i> Gestión de Postulaciones</h1>
    <p>Administra las postulaciones de estudiantes a vacantes</p>
</div>

<!-- Estadísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card" style="border-top: 3px solid #0dcaf0;">
            <div class="card-body text-center">
                <h2 style="font-size: 2.5rem; margin-bottom: 10px; color: #0dcaf0;">
                    {{ total_postulaciones }}
                </h2>
                <p style="margin: 0; color: #6c757d;">Total</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card" style="border-top: 3px solid #ffc107;">
            <div class="card-body text-center">
                <h2 style="font-size: 2.5rem; margin-bottom: 10px; color: #ffc107;">
                    {{ pendientes }}
                </h2>
                <p style="margin: 0; color: #6c757d;">Pendientes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card" style="border-top: 3px solid #198754;">
            <div class="card-body text-center">
                <h2 style="font-size: 2.5rem; margin-bottom: 10px; color: #198754;">
                    {{ aceptadas }}
                </h2>
                <p style="margin: 0; color: #6c757d;">Aceptadas</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card" style="border-top: 3px solid #dc3545;">
            <div class="card-body text-center">
                <h2 style="font-size: 2.5rem; margin-bottom: 10px; color: #dc3545;">
                    {{ rechazadas }}
                </h2>
                <p style="margin: 0; color: #6c757d;">Rechazadas</p>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <input type="text" name="search" class="form-control" placeholder="Buscar estudiante..." value="{{ request.GET.search }}">
            </div>
            <div class="col-md-2">
                <select name="estado" class="form-select">
                    <option value="">Todos los estados</option>
                    <option value="EN_REVISION" {% if request.GET.estado == 'EN_REVISION' %}selected{% endif %}>En Revisión</option>
                    <option value="ACEPTADA" {% if request.GET.estado == 'ACEPTADA' %}selected{% endif %}>Aceptada</option>
                    <option value="RECHAZADA" {% if request.GET.estado == 'RECHAZADA' %}selected{% endif %}>Rechazada</option>
                </select>
            </div>
            <div class="col-md-3">
                <select name="empresa" class="form-select">
                    <option value="">Todas las empresas</option>
                    {% for empresa in empresas %}
                    <option value="{{ empresa.id }}">{{ empresa.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select name="origen" class="form-select">
                    <option value="">Origen</option>
                    <option value="ESTUDIANTE">Estudiante</option>
                    <option value="COORDINADOR">Coordinador</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-dark w-100">
                    <i class="fas fa-search"></i> Filtrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Lista de Postulaciones -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-list"></i> Lista de Postulaciones ({{ postulaciones.count }})</h5>
        <div>
            <button class="btn btn-sm btn-outline-dark" onclick="exportarExcel()">
                <i class="fas fa-file-excel"></i> Exportar
            </button>
        </div>
    </div>
    <div class="card-body">
        {% if postulaciones %}
            <div class="table-responsive">
                <table class="table table-hover" id="tablaPpostulaciones">
                    <thead style="background-color: #f8f9fa;">
                        <tr>
                            <th style="font-weight: 600;"><i class="fas fa-calendar"></i> Fecha</th>
                            <th style="font-weight: 600;"><i class="fas fa-user-graduate"></i> Estudiante</th>
                            <th style="font-weight: 600;"><i class="fas fa-file-alt"></i> Vacante</th>
                            <th style="font-weight: 600;"><i class="fas fa-building"></i> Empresa</th>
                            <th style="font-weight: 600;"><i class="fas fa-info-circle"></i> Estado</th>
                            <th style="font-weight: 600;"><i class="fas fa-tag"></i> Origen</th>
                            <th style="font-weight: 600;"><i class="fas fa-cog"></i> Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for postulacion in postulaciones %}
                        <tr>
                            <td style="vertical-align: middle;">
                                <small style="color: #6c757d;">{{ postulacion.fecha_postulacion|date:"d/m/Y H:i" }}</small>
                            </td>
                            <td style="vertical-align: middle;">
                                <div>
                                    <strong>{{ postulacion.estudiante.usuario.get_full_name }}</strong>
                                    <br>
                                    <small style="color: #6c757d;">{{ postulacion.estudiante.programa_academico }}</small>
                                </div>
                            </td>
                            <td style="vertical-align: middle;">{{ postulacion.vacante.titulo }}</td>
                            <td style="vertical-align: middle;">
                                <span style="font-weight: 500;">{{ postulacion.vacante.empresa.nombre }}</span>
                            </td>
                            <td style="vertical-align: middle;">
                                {% if postulacion.estado == 'EN_REVISION' %}
                                    <span class="badge" style="background-color: #fff3cd; color: #664d03; font-size: 0.85rem;">
                                        <i class="fas fa-clock"></i> En Revisión
                                    </span>
                                {% elif postulacion.estado == 'ACEPTADA' %}
                                    <span class="badge" style="background-color: #d1f0e3; color: #0f5130; font-size: 0.85rem;">
                                        <i class="fas fa-check"></i> Aceptada
                                    </span>
                                {% elif postulacion.estado == 'RECHAZADA' %}
                                    <span class="badge" style="background-color: #f8d7da; color: #842029; font-size: 0.85rem;">
                                        <i class="fas fa-times"></i> Rechazada
                                    </span>
                                {% endif %}
                            </td>
                            <td style="vertical-align: middle;">
                                {% if postulacion.origen == 'ESTUDIANTE' %}
                                    <span class="badge" style="background-color: #e7f1ff; color: #004085; font-size: 0.85rem;">
                                        <i class="fas fa-user"></i> Estudiante
                                    </span>
                                {% else %}
                                    <span class="badge" style="background-color: #cfe2ff; color: #052c65; font-size: 0.85rem;">
                                        <i class="fas fa-user-tie"></i> Coordinador
                                    </span>
                                {% endif %}
                            </td>
                            <td style="vertical-align: middle;">
                                <div class="btn-group" role="group">
                                    <a href="{% url 'usuarios:ver_documentos_estudiante' postulacion.estudiante.id %}" class="btn btn-sm btn-dark" title="Ver Hoja de Vida">
                                        <i class="fas fa-file-pdf"></i>
                                    </a>
                                    <a href="{% url 'empresas:vacante_detail' postulacion.vacante.id %}" class="btn btn-sm btn-outline-dark" title="Ver Vacante">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div style="text-align: center; color: #6c757d; padding: 60px 20px;">
                <i class="fas fa-handshake" style="font-size: 3.5rem; color: #6f42c1; opacity: 0.3; margin-bottom: 20px; display: block;"></i>
                <h5 style="color: #212529; margin-bottom: 10px;">No hay postulaciones registradas</h5>
                <p style="margin-bottom: 20px;">Las postulaciones de estudiantes a vacantes aparecerán aquí.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Información Adicional -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Gestión de Postulaciones</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-check-circle" style="color: #198754;"></i> Estados de Postulación</h6>
                <ul style="font-size: 0.9rem; color: #6c757d;">
                    <li><strong>En Revisión:</strong> Postulación pendiente de evaluación</li>
                    <li><strong>Aceptada:</strong> Estudiante seleccionado para la vacante</li>
                    <li><strong>Rechazada:</strong> Postulación no aceptada</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-users" style="color: #0dcaf0;"></i> Origen de Postulaciones</h6>
                <ul style="font-size: 0.9rem; color: #6c757d;">
                    <li><strong>Estudiante:</strong> Postulación realizada por el estudiante</li>
                    <li><strong>Coordinador:</strong> Asignación directa del coordinador</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{% url 'dashboard_coordinador' %}" class="btn btn-dark">
        <i class="fas fa-arrow-left"></i> Volver al Dashboard
    </a>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Efecto hover en filas de tabla
document.querySelectorAll('#tablaPpostulaciones tbody tr').forEach(row => {
    row.addEventListener('mouseenter', function() {
        this.style.backgroundColor = '#f8f9fa';
    });

    row.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '';
    });
});

// Función para exportar a Excel (placeholder)
function exportarExcel() {
    alert('Función de exportación a Excel en desarrollo');
}
</script>
{% endblock %}

